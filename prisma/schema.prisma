// -----------------------------------------------------------------------------
// KRONOS CRM - SCHEMA V3.2 — Planos DB-driven + Infraestrutura de Créditos
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum MemberStatus {
  PENDING
  ACCEPTED
}

enum PersonType {
  PJ // Pessoa Jurídica
  PF // Pessoa Física
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  trialing
  incomplete
}

enum CompanySize {
  SIZE_1_10    @map("1-10")
  SIZE_11_50   @map("11-50")
  SIZE_50_PLUS @map("50+")
}

enum ActivityType {
  note
  call
  email
  meeting
  stage_change
  product_added
  product_removed
  product_updated
  task_created
  task_completed
  deal_won
  deal_lost
  deal_reopened
  assignee_changed
  priority_changed
  deal_paused
  deal_unpaused
  date_changed
  contact_added
  contact_removed
}

enum TaskType {
  TASK
  MEETING
  CALL
  WHATSAPP
  VISIT
  EMAIL
}

enum DiscountType {
  percentage
  fixed
}

enum FeatureType {
  STATIC
  METERED
}

enum FeatureValueType {
  NUMBER
  BOOLEAN
  STRING
}

enum WalletTransactionType {
  CREDIT_PURCHASE
  USAGE_DEBIT
  MONTHLY_RESET
  AUTO_RECHARGE
  MANUAL_ADJUSTMENT
  REFUND
  SYSTEM_REFUND
  EXPIRATION
}

enum DealPriority {
  low
  medium
  high
  urgent
}

enum DealStatus {
  OPEN
  IN_PROGRESS
  WON
  LOST
  PAUSED
}

// -----------------------------------------------------------------------------
// MODELS
// -----------------------------------------------------------------------------

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  fullName  String? @map("full_name")
  avatarUrl String? @map("avatar_url")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos Ativos
  memberships      Member[]
  dealsAssigned    Deal[]         @relation("DealAssignee")
  contactsAssigned Contact[]      @relation("ContactAssignee")
  tasksAssigned    Task[]         @relation("TaskAssignee")
  tasksCreated     Task[]         @relation("TaskCreator")
  activitiesPerformed Activity[] @relation("ActivityPerformer")

  @@map("users")
}

model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  stripeCustomerId String? @map("stripe_customer_id")

  // Dados Cadastrais
  personType PersonType? @map("person_type")
  taxId      String?     @map("tax_id") // CNPJ ou CPF (apenas dígitos)
  legalName  String?     @map("legal_name") // Razão Social ou Nome Completo
  tradeName  String?     @map("trade_name") // Nome Fantasia (apenas PJ)
  isSimples  Boolean     @default(false) @map("is_simples")

  // Contato Financeiro
  billingContactName  String? @map("billing_contact_name")
  billingContactEmail String? @map("billing_contact_email")
  billingContactPhone String? @map("billing_contact_phone")

  // Endereço de Faturamento
  billingZipCode      String? @map("billing_zip_code")
  billingStreet       String? @map("billing_street")
  billingNumber       String? @map("billing_number")
  billingComplement   String? @map("billing_complement")
  billingNeighborhood String? @map("billing_neighborhood")
  billingCity         String? @map("billing_city")
  billingState        String? @map("billing_state")
  billingCountry      String? @default("BR") @map("billing_country")

  trialEndsAt DateTime? @map("trial_ends_at")
  isReadOnly  Boolean   @default(false) @map("is_read_only")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members       Member[]
  contacts      Contact[]
  companies     Company[]
  pipelines     Pipeline[]
  products      Product[]
  tasks         Task[]
  Deal          Deal[]
  subscriptions Subscription[]
  lostReasons   DealLostReason[]
  creditWallet  CreditWallet?
  aiUsage       AiUsage[]

  @@map("organizations")
}

model Member {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  email           String
  role            MemberRole   @default(MEMBER)
  status          MemberStatus @default(PENDING)
  invitationToken String?      @unique @map("invitation_token")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, email])
  @@map("members")
}

model Subscription {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  stripePriceId        String             @map("stripe_price_id")
  status               SubscriptionStatus @default(active)
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  metadata             Json?

  planId String? @map("plan_id")
  plan   Plan?   @relation(fields: [planId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscriptions")
}

model Company {
  id       String       @id @default(uuid())
  name     String
  domain   String?
  industry String?
  size     CompanySize?
  address  String?

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contacts Contact[]
  deals    Deal[]

  @@map("companies")
}

model Contact {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  assignedTo String? @map("assigned_to")
  assignee   User?   @relation("ContactAssignee", fields: [assignedTo], references: [id])

  name            String
  email           String?
  phone           String?
  role            String?
  cpf             String?
  isDecisionMaker Boolean @default(false) @map("is_decision_maker")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deals DealContact[]

  @@map("contacts")
}

model Pipeline {
  id   String @id @default(uuid())
  name String

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  stages PipelineStage[]

  @@map("pipelines")
}

model PipelineStage {
  id         String   @id @default(uuid())
  pipelineId String   @map("pipeline_id")
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  name     String
  position Int
  color    String?

  deals Deal[]

  @@map("pipeline_stages")
}

model Deal {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  pipelineStageId String        @map("pipeline_stage_id")
  stage           PipelineStage @relation(fields: [pipelineStageId], references: [id])

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  contacts DealContact[]

  title             String
  priority          DealPriority @default(medium)
  status            DealStatus   @default(OPEN)
  notes             String?      @db.Text
  lostReason        String?
  pausedAt          DateTime?    @map("paused_at")
  expectedCloseDate DateTime?    @map("expected_close_date")

  assignedTo String @map("assigned_to")
  assignee   User   @relation("DealAssignee", fields: [assignedTo], references: [id])

  lossReasonId String? @map("loss_reason_id")
  lossReason   DealLostReason? @relation(fields: [lossReasonId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dealProducts DealProduct[]
  tasks        Task[]
  activities   Activity[]

  @@map("deals")
}

model Task {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  title       String
  type        TaskType @default(TASK)
  dueDate     DateTime @map("due_date")
  isCompleted Boolean  @default(false) @map("is_completed")

  assignedTo String @map("assigned_to")
  assignee   User   @relation("TaskAssignee", fields: [assignedTo], references: [id])

  createdBy String @map("created_by")
  creator   User   @relation("TaskCreator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("tasks")
}

model Activity {
  id     String @id @default(uuid())
  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  type    ActivityType
  content String       @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  performedBy String? @map("performed_by")
  performer   User?   @relation("ActivityPerformer", fields: [performedBy], references: [id])

  @@map("activities")
}

model Product {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Decimal @db.Decimal(15, 2)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dealProducts DealProduct[]

  @@map("products")
}

model DealProduct {
  id        String  @id @default(uuid())
  dealId    String  @map("deal_id")
  deal      Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int     @default(1)
  unitPrice Decimal @map("unit_price") @db.Decimal(15, 2)

  discountType  DiscountType @default(percentage) @map("discount_type")
  discountValue Decimal      @default(0) @map("discount_value") @db.Decimal(15, 2)

  @@map("deal_products")
}

model DealContact {
  id String @id @default(uuid())

  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id")
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  role      String?
  isPrimary Boolean @default(false) @map("is_primary")

  @@unique([dealId, contactId])
  @@map("deal_contacts")
}

model DealLostReason {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name     String
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deals Deal[]

  @@index([organizationId])
  @@map("deal_lost_reasons")
}

// -----------------------------------------------------------------------------
// PLANOS DB-DRIVEN
// -----------------------------------------------------------------------------

model Feature {
  id   String @id @default(uuid())
  key         String @unique // ex: "crm.max_contacts"
  name        String
  description String?

  type      FeatureType      @default(STATIC)
  valueType FeatureValueType @default(NUMBER) @map("value_type")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  planLimits PlanLimit[]

  @@map("features")
}

model Plan {
  id   String @id @default(uuid())
  slug String @unique // ex: "essential", "scale", "enterprise"
  name String

  stripeProductId String? @map("stripe_product_id")
  description     String?
  isActive        Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  planLimits    PlanLimit[]
  subscriptions Subscription[]

  @@map("plans")
}

model PlanLimit {
  id String @id @default(uuid())

  planId String @map("plan_id")
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  featureId String  @map("feature_id")
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  valueNumber  Int?     @map("value_number")
  valueBoolean Boolean? @map("value_boolean")
  valueString  String?  @map("value_string")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([planId, featureId])
  @@map("plan_limits")
}

// -----------------------------------------------------------------------------
// INFRAESTRUTURA DE CRÉDITOS IA
// -----------------------------------------------------------------------------

model CreditWallet {
  id String @id @default(uuid())

  organizationId String       @unique @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // BUCKET 1: Franquia do Plano (Use-it-or-lose-it)
  // Reinicia todo mês para o valor definido em PlanLimit['ai.messages_quota']
  planBalance  Int @default(0) @map("plan_balance")

  // BUCKET 2: Lojinha (Perpétuo)
  // Só aumenta com compras avulsas e diminui com uso após fim do planBalance
  topUpBalance Int @default(0) @map("top_up_balance")

  // Config de Auto-Recarga Inteligente
  autoRechargeEnabled      Boolean @default(false) @map("auto_recharge_enabled")
  // "Gatilho": Quando a SOMA (planBalance + topUpBalance) cair abaixo disso...
  autoRechargeTrigger      Int     @default(10)    @map("auto_recharge_trigger")
  // "Ação": ...cobra o cartão e adiciona essa quantidade ao topUpBalance.
  autoRechargeAmount       Int     @default(100)   @map("auto_recharge_amount")
  // Trava de segurança: evita loops de cobrança em caso de bug ou consumo desenfreado
  maxAutoRechargesPerMonth Int     @default(5)     @map("max_auto_recharges_per_month")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  transactions WalletTransaction[]

  @@map("credit_wallets")
}

model WalletTransaction {
  id String @id @default(uuid())

  walletId String       @map("wallet_id")
  wallet   CreditWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  type   WalletTransactionType
  // Positivo para créditos, negativo para débitos
  amount Int

  // Snapshot do estado DEPOIS da transação — essencial para auditoria e debug
  // Permite saber de qual bucket o crédito saiu sem precisar recalcular o histórico
  balanceAfterPlan  Int @map("balance_after_plan")
  balanceAfterTopUp Int @map("balance_after_top_up")

  // Descrição legível para o extrato do cliente (obrigatório)
  description String
  // Detalhes técnicos: ticket_id, tokens consumidos, modelo de IA, etc.
  metadata    Json?

  // Somente INSERT — nunca atualizar ou deletar (imutabilidade auditável)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([walletId])
  @@map("wallet_transactions")
}

model AiUsage {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Acumulado histórico para BI
  totalMessagesUsed Int @default(0) @map("total_messages_used")
  totalCreditsSpent Int @default(0) @map("total_credits_spent")

  // Período de referência (ex: 2026-02 para fevereiro/2026)
  periodYear  Int @map("period_year")
  periodMonth Int @map("period_month")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, periodYear, periodMonth])
  @@map("ai_usages")
}
