// -----------------------------------------------------------------------------
// KRONOS CRM - SCHEMA OTIMIZADO (V2.0)
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum MemberStatus {
  PENDING
  ACCEPTED
}

enum PersonType {
  PJ // Pessoa Jurídica
  PF // Pessoa Física
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  trialing
  incomplete
}

enum CompanySize {
  SIZE_1_10    @map("1-10")
  SIZE_11_50   @map("11-50")
  SIZE_50_PLUS @map("50+")
}

enum ActivityType {
  note
  call
  email
  meeting
  stage_change
  product_added
  product_removed
  task_created
  task_completed
  deal_won
  deal_lost
  deal_reopened
}

enum TaskType {
  TASK
  MEETING
  CALL
  WHATSAPP
  VISIT
  EMAIL
}

enum DiscountType {
  percentage
  fixed
}

enum DealPriority {
  low
  medium
  high
  urgent
}

enum DealStatus {
  OPEN
  IN_PROGRESS
  WON
  LOST
  PAUSED
}

// -----------------------------------------------------------------------------
// MODELS
// -----------------------------------------------------------------------------

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  fullName  String? @map("full_name")
  avatarUrl String? @map("avatar_url")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos Ativos
  memberships      Member[]
  dealsAssigned    Deal[]         @relation("DealAssignee")
  contactsAssigned Contact[]      @relation("ContactAssignee")
  tasksAssigned    Task[]         @relation("TaskAssignee")
  tasksCreated     Task[]         @relation("TaskCreator")

  @@map("users")
}

model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  stripeCustomerId String? @map("stripe_customer_id")

  // Dados Cadastrais
  personType PersonType? @map("person_type")
  taxId      String?     @map("tax_id") // CNPJ ou CPF (apenas dígitos)
  legalName  String?     @map("legal_name") // Razão Social ou Nome Completo
  tradeName  String?     @map("trade_name") // Nome Fantasia (apenas PJ)
  isSimples  Boolean     @default(false) @map("is_simples")

  // Contato Financeiro
  billingContactName  String? @map("billing_contact_name")
  billingContactEmail String? @map("billing_contact_email")
  billingContactPhone String? @map("billing_contact_phone")

  // Endereço de Faturamento
  billingZipCode      String? @map("billing_zip_code")
  billingStreet       String? @map("billing_street")
  billingNumber       String? @map("billing_number")
  billingComplement   String? @map("billing_complement")
  billingNeighborhood String? @map("billing_neighborhood")
  billingCity         String? @map("billing_city")
  billingState        String? @map("billing_state")
  billingCountry      String? @default("BR") @map("billing_country")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members       Member[]
  contacts      Contact[]
  companies     Company[]
  pipelines     Pipeline[]
  products      Product[]
  tasks         Task[]
  Deal          Deal[]
  subscriptions Subscription[]

  @@map("organizations")
}

model Member {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  email           String
  role            MemberRole   @default(MEMBER)
  status          MemberStatus @default(PENDING)
  invitationToken String?      @unique @map("invitation_token")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, email])
  @@map("members")
}

model Subscription {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  stripePriceId        String             @map("stripe_price_id")
  status               SubscriptionStatus @default(active)
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  metadata             Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscriptions")
}

model Company {
  id       String       @id @default(uuid())
  name     String
  domain   String?
  industry String?
  size     CompanySize?
  address  String?

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contacts Contact[]
  deals    Deal[]

  @@map("companies")
}

model Contact {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  assignedTo String? @map("assigned_to")
  assignee   User?   @relation("ContactAssignee", fields: [assignedTo], references: [id])

  name            String
  email           String?
  phone           String?
  role            String?
  cpf             String?
  isDecisionMaker Boolean @default(false) @map("is_decision_maker")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deals DealContact[]

  @@map("contacts")
}

model Pipeline {
  id   String @id @default(uuid())
  name String

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  stages PipelineStage[]

  @@map("pipelines")
}

model PipelineStage {
  id         String   @id @default(uuid())
  pipelineId String   @map("pipeline_id")
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  name     String
  position Int
  color    String?

  deals Deal[]

  @@map("pipeline_stages")
}

model Deal {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  pipelineStageId String        @map("pipeline_stage_id")
  stage           PipelineStage @relation(fields: [pipelineStageId], references: [id])

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  contacts DealContact[]

  title             String
  priority          DealPriority @default(medium)
  status            DealStatus   @default(OPEN)
  notes             String?      @db.Text
  lostReason        String?
  pausedAt          DateTime?    @map("paused_at")
  expectedCloseDate DateTime?    @map("expected_close_date")

  assignedTo String @map("assigned_to")
  assignee   User   @relation("DealAssignee", fields: [assignedTo], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dealProducts DealProduct[]
  tasks        Task[]
  activities   Activity[]

  @@map("deals")
}

model Task {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  dealId String? @map("deal_id")
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  title       String
  type        TaskType  @default(TASK)
  dueDate     DateTime? @map("due_date")
  isCompleted Boolean   @default(false) @map("is_completed")

  assignedTo String @map("assigned_to")
  assignee   User   @relation("TaskAssignee", fields: [assignedTo], references: [id])

  createdBy String @map("created_by")
  creator   User   @relation("TaskCreator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("tasks")
}

model Activity {
  id     String @id @default(uuid())
  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  type    ActivityType
  content String       @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@map("activities")
}

model Product {
  id String @id @default(uuid())

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Decimal @db.Decimal(15, 2)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dealProducts DealProduct[]

  @@map("products")
}

model DealProduct {
  id        String  @id @default(uuid())
  dealId    String  @map("deal_id")
  deal      Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int     @default(1)
  unitPrice Decimal @map("unit_price") @db.Decimal(15, 2)

  discountType  DiscountType @default(percentage) @map("discount_type")
  discountValue Decimal      @default(0) @map("discount_value") @db.Decimal(15, 2)

  @@map("deal_products")
}

model DealContact {
  id String @id @default(uuid())

  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id")
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  role      String? @default("Stakeholder")
  isPrimary Boolean @default(false) @map("is_primary")

  @@unique([dealId, contactId])
  @@map("deal_contacts")
}
